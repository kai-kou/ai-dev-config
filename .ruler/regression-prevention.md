# デグレ防止ルール（Regression Prevention）

## 原則

コード変更は常にデグレッション（既存機能の劣化）リスクを伴う。
変更前の影響評価・変更中のリスク意識・変更後の整合性確認を習慣化すること。

## 保存時チェック（常時適用）

ファイルを変更・保存するたびに以下を実施すること:

### 構文・フォーマット

- Lintエラー: 変更後に確認。自分が導入したエラーは即修正
- YAML構文: フロントマター付き `.md` のパースエラーがないこと
- Markdown構造: テーブル構造の崩れ、リンク切れがないこと
- インデント: プロジェクトの既存スタイルと一致すること

### 整合性

- YAMLフロントマター集計値（total, completed, progress等）が実データと一致すること
- 相互参照の有効性: 参照先が実在すること（ファイルパス・タスクID・マイルストーンID）
- テンプレート構造の維持: 必須セクション・カラムが欠落していないこと
- 命名の一貫性: プロジェクト内の既存命名規則に従うこと

### スコープ

- 変更がタスクの完了条件に直接寄与するものであること
- 「ついでに」タスクと無関係な修正を混入させないこと
- 目的を達成する最小限の変更にとどめること

## 変更リスク分類

| ファイルパターン | リスク | 必要な注意 |
|----------------|--------|----------|
| `**/api/**`, `**/routes/**`, `**/models/**`, `**/schema/**` | 高 | 呼び出し元・全参照箇所の確認必須 |
| `**/config/**`, `*.env*`, `*.yaml`, `*.toml` | 高 | 影響範囲の事前分析必須 |
| `**/auth/**`, `**/security/**` | 高 | セキュリティレビュー必須 |
| `**/utils/**`, `**/lib/**`, `**/helpers/**` | 中 | 利用箇所の確認 |
| `**/templates/**`, `**/rules/**` | 中 | 既存ワークフローとの整合性確認 |
| `*.md`（ドキュメント）, `**/docs/**`, `**/tests/**` | 低 | 基本的な整合性確認 |

| 変更種別 | リスク加重 | 必須アクション |
|---------|----------|-------------|
| ファイル/関数/クラス削除 | 最高 | 全参照箇所の確認。参照切れが発生しないこと |
| インターフェース変更（引数追加/削除/型変更） | 高 | 呼び出し元の全数修正 |
| 名前変更（リネーム） | 高 | 参照箇所の全数更新。Grepで漏れ確認 |
| ロジック変更（既存関数の振る舞い変更） | 中 | 影響を受ける機能のテスト・確認 |
| 新規追加 | 低 | 既存機能への影響は低いが整合性を確認 |

## 変更前の必須チェック

- **高リスク**: 影響範囲の事前分析（Grepで調査）、変更理由の明確化、ロールバック計画
- **中リスク**: 参照箇所の確認、連携先への影響把握
- **低リスク**: 基本的な整合性確認

## 変更後の必須チェック

1. Lintエラー確認: 新規導入エラーは即修正
2. YAMLフロントマター: 集計値がある場合は再計算
3. 参照の有効性: 変更・削除したファイル名・関数名が他で参照されていないか確認

## 禁止事項

- Lintエラーを確認せずにタスク完了を報告すること
- 高リスクファイルを影響分析なしに変更すること
- ファイル削除時に参照箇所を確認しないこと
- YAMLフロントマターの集計値を更新し忘れること
- スコープ外修正の混入
